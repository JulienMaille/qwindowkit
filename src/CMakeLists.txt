
set(QWINDOWKIT_GENERATED_INCLUDE_DIR ${CMAKE_BINARY_DIR}/include)
set(QWINDOWKIT_BUILD_INCLUDE_DIR ${CMAKE_BINARY_DIR}/include)

set(QWINDOWKIT_ENABLED_TARGETS)
set(QWINDOWKIT_ENABLED_SUBDIRECTORIES)

# ----------------------------------
# Find Qt
# ----------------------------------
find_package(QT NAMES Qt6 Qt5 COMPONENTS Core Gui REQUIRED)
find_package(Qt${QT_VERSION_MAJOR} COMPONENTS Core Gui REQUIRED)

if(QWINDOWKIT_BUILD_WIDGETS)
    find_package(Qt${QT_VERSION_MAJOR} COMPONENTS Widgets REQUIRED)
endif()

if(QWINDOWKIT_BUILD_QUICK)
    find_package(Qt${QT_VERSION_MAJOR} COMPONENTS Quick REQUIRED)
endif()

# ----------------------------------
# Configurations
# ----------------------------------

# Calculate configuration values (1 or -1)
if(QWINDOWKIT_ENABLE_QT_WINDOW_CONTEXT)
    set(_VAL_ENABLE_QT_WINDOW_CONTEXT 1)
else()
    set(_VAL_ENABLE_QT_WINDOW_CONTEXT -1)
endif()

if(QWINDOWKIT_ENABLE_STYLE_AGENT)
    set(_VAL_ENABLE_STYLE_AGENT 1)
else()
    set(_VAL_ENABLE_STYLE_AGENT -1)
endif()

if(QWINDOWKIT_ENABLE_WINDOWS_SYSTEM_BORDERS)
    set(_VAL_ENABLE_WINDOWS_SYSTEM_BORDERS 1)
else()
    set(_VAL_ENABLE_WINDOWS_SYSTEM_BORDERS -1)
endif()

# Generate qwkconfig.h
set(_qwk_config_content
"/* This file is automatically generated by CMake. */
#ifndef QWKCONFIG_H
#define QWKCONFIG_H

#define QWINDOWKIT_ENABLE_QT_WINDOW_CONTEXT ${_VAL_ENABLE_QT_WINDOW_CONTEXT}
#define QWINDOWKIT_ENABLE_STYLE_AGENT ${_VAL_ENABLE_STYLE_AGENT}
#define QWINDOWKIT_ENABLE_WINDOWS_SYSTEM_BORDERS ${_VAL_ENABLE_WINDOWS_SYSTEM_BORDERS}

#endif // QWKCONFIG_H
")

set(_qwk_config_path "${QWINDOWKIT_GENERATED_INCLUDE_DIR}/QWKCore/qwkconfig.h")
if(EXISTS "${_qwk_config_path}")
    file(READ "${_qwk_config_path}" _old_content)
else()
    set(_old_content "")
endif()

if(NOT "${_old_content}" STREQUAL "${_qwk_config_content}")
    file(WRITE "${_qwk_config_path}" "${_qwk_config_content}")
endif()

if(QWINDOWKIT_INSTALL)
    install(FILES ${_qwk_config_path}
        DESTINATION ${CMAKE_INSTALL_INCLUDEDIR}/${QWINDOWKIT_INSTALL_NAME}/QWKCore
    )
endif()

# ----------------------------------
# CMake API
# ----------------------------------
macro(qwk_add_library _target)
    set(options AUTOGEN NO_SYNC_INCLUDE NO_WIN_RC)
    set(oneValueArgs SYNC_INCLUDE_PREFIX PREFIX)
    set(multiValueArgs
        SYNC_INCLUDE_OPTIONS
        SOURCES
        LINKS LINKS_INTERFACE LINKS_PRIVATE
        INCLUDE INCLUDE_INTERFACE INCLUDE_PRIVATE
        LINKDIR LINKDIR_INTERFACE LINKDIR_PRIVATE
        DEFINES DEFINES_INTERFACE DEFINES_PRIVATE
        FEATURES FEATURES_INTERFACE FEATURES_PRIVATE
        CCFLAGS CCFLAGS_INTERFACE CCFLAGS_PUBLIC
        LDFLAGS LDFLAGS_INTERFACE LDFLAGS_PUBLIC
        QT_LINKS QT_LINKS_PRIVATE QT_LINKS_INTERFACE
        QT_INCLUDE_PRIVATE
        SKIP_AUTOMOC
    )
    cmake_parse_arguments(FUNC "${options}" "${oneValueArgs}" "${multiValueArgs}" ${ARGN})

    if(FUNC_AUTOGEN)
        set(CMAKE_AUTOMOC ON)
        set(CMAKE_AUTOUIC ON)
        set(CMAKE_AUTORCC ON)
    endif()

    if(QWINDOWKIT_BUILD_STATIC)
        set(_type STATIC)
    else()
        set(_type SHARED)
    endif()

    add_library(${_target} ${_type} ${FUNC_SOURCES})

    if(WIN32 AND NOT FUNC_NO_WIN_RC AND (${_type} STREQUAL "SHARED"))
        # Parse version
        string(REPLACE "." ";" _version_list ${QWINDOWKIT_VERSION})
        list(LENGTH _version_list _version_count)
        list(PREPEND _version_list 0)

        set(_ver_str "")
        foreach(_i RANGE 1 4)
            if(_i LESS_EQUAL _version_count)
                list(GET _version_list ${_i} _item)
            else()
                set(_item 0)
            endif()
            if(_ver_str)
                set(_ver_str "${_ver_str},${_item}")
            else()
                set(_ver_str "${_item}")
            endif()
        endforeach()

        set(RC_VERSION ${_ver_str})
        set(RC_VERSION_STRING ${QWINDOWKIT_VERSION})
        set(RC_COMPANY "Stdware Collections")
        set(RC_DESCRIPTION ${QWINDOWKIT_DESCRIPTION})
        set(RC_COPYRIGHT ${QWINDOWKIT_COPYRIGHT})
        set(RC_APPLICATION_NAME ${_target})
        set(RC_INTERNAL_NAME ${_target})
        set(RC_ORIGINAL_FILENAME "$<TARGET_FILE_NAME:${_target}>")

        set(_rc_file "${CMAKE_CURRENT_BINARY_DIR}/${_target}_resource.rc")
        configure_file("${CMAKE_SOURCE_DIR}/cmake/windows/WinResource.rc.in" "${_rc_file}" @ONLY)
        target_sources(${_target} PRIVATE "${_rc_file}")
    endif()

    if(FUNC_LINKS)
        target_link_libraries(${_target} PUBLIC ${FUNC_LINKS})
    endif()
    if(FUNC_LINKS_PRIVATE)
        target_link_libraries(${_target} PRIVATE ${FUNC_LINKS_PRIVATE})
    endif()

    if(FUNC_QT_LINKS)
        foreach(_qt_mod ${FUNC_QT_LINKS})
            target_link_libraries(${_target} PUBLIC Qt${QT_VERSION_MAJOR}::${_qt_mod})
        endforeach()
    endif()

    if(FUNC_QT_INCLUDE_PRIVATE)
        foreach(_qt_mod ${FUNC_QT_INCLUDE_PRIVATE})
            find_package(Qt${QT_VERSION_MAJOR} COMPONENTS ${_qt_mod}Private QUIET)
            if(TARGET Qt${QT_VERSION_MAJOR}::${_qt_mod}Private)
                target_link_libraries(${_target} PRIVATE Qt${QT_VERSION_MAJOR}::${_qt_mod}Private)
            else()
                 # Fallback
            endif()
        endforeach()
    endif()

    if(FUNC_INCLUDE_PRIVATE)
        if("${FUNC_INCLUDE_PRIVATE}" STREQUAL "*")
            # Find all subdirectories
            file(GLOB_RECURSE _all_files LIST_DIRECTORIES true "*")
            set(_dirs ${CMAKE_CURRENT_SOURCE_DIR})
            foreach(_file ${_all_files})
                if(IS_DIRECTORY ${_file})
                    list(APPEND _dirs ${_file})
                endif()
            endforeach()
            target_include_directories(${_target} PRIVATE ${_dirs})
        else()
             target_include_directories(${_target} PRIVATE ${FUNC_INCLUDE_PRIVATE})
        endif()
    endif()

    if(FUNC_FEATURES)
        target_compile_features(${_target} PUBLIC ${FUNC_FEATURES})
    endif()

    if(FUNC_PREFIX)
        set(_prefix ${FUNC_PREFIX})
    else()
        string(TOUPPER ${_target} _prefix)
        string(MAKE_C_IDENTIFIER ${_prefix} _prefix)
    endif()

    if(${_type} STREQUAL "STATIC_LIBRARY")
        target_compile_definitions(${_target} PUBLIC ${_prefix}_STATIC)
    else()
        target_compile_definitions(${_target} PRIVATE ${_prefix}_LIBRARY)
    endif()

    target_include_directories(${_target} PRIVATE ${QWINDOWKIT_BUILD_INCLUDE_DIR})
    target_include_directories(${_target} PRIVATE .)

    if(${_target} MATCHES "^QWK(.+)")
        set(_name ${CMAKE_MATCH_1})
        set_target_properties(${_target} PROPERTIES EXPORT_NAME ${_name})
    else()
        set(_name ${_target})
    endif()

    add_library(${QWINDOWKIT_INSTALL_NAME}::${_name} ALIAS ${_target})

    if(FUNC_SYNC_INCLUDE_PREFIX)
        set(_inc_name ${FUNC_SYNC_INCLUDE_PREFIX})
    else()
        set(_inc_name ${_target})
    endif()

    # Sync Include Logic
    if(NOT FUNC_NO_SYNC_INCLUDE)
        file(GLOB_RECURSE _headers LIST_DIRECTORIES false "*.h")

        set(_dest_dir "${QWINDOWKIT_GENERATED_INCLUDE_DIR}/${_inc_name}")
        set(_dest_dir_private "${QWINDOWKIT_GENERATED_INCLUDE_DIR}/${_inc_name}/private")

        file(MAKE_DIRECTORY "${_dest_dir}")
        file(MAKE_DIRECTORY "${_dest_dir_private}")

        foreach(_hdr ${_headers})
            get_filename_component(_hdr_name ${_hdr} NAME)

            # Check for exclusions
            set(_skip OFF)
            if(FUNC_SYNC_INCLUDE_OPTIONS)
                 list(LENGTH FUNC_SYNC_INCLUDE_OPTIONS _len)
                 math(EXPR _len "${_len} - 1")
                 foreach(_i RANGE 0 ${_len})
                    list(GET FUNC_SYNC_INCLUDE_OPTIONS ${_i} _opt)
                    if("${_opt}" STREQUAL "EXCLUDE")
                        math(EXPR _next_i "${_i} + 1")
                        if(_next_i LE ${_len})
                            list(GET FUNC_SYNC_INCLUDE_OPTIONS ${_next_i} _pattern)
                            file(RELATIVE_PATH _rel_from_src "${CMAKE_CURRENT_SOURCE_DIR}" "${_hdr}")
                            if("${_rel_from_src}" MATCHES "${_pattern}")
                                set(_skip ON)
                            endif()
                        endif()
                    endif()
                 endforeach()
            endif()

            if(NOT _skip)
                file(RELATIVE_PATH _rel_path "${_dest_dir}" "${_hdr}")
                set(_content "#include \"${_rel_path}\"\n")

                # Check if private
                if("${_hdr_name}" MATCHES "_p\\.h$")
                    file(RELATIVE_PATH _rel_path_p "${_dest_dir_private}" "${_hdr}")
                    set(_content_p "#include \"${_rel_path_p}\"\n")

                    set(_outfile "${_dest_dir_private}/${_hdr_name}")
                    if(EXISTS "${_outfile}")
                        file(READ "${_outfile}" _old)
                    else()
                        set(_old "")
                    endif()
                    if(NOT "${_old}" STREQUAL "${_content_p}")
                        file(WRITE "${_outfile}" "${_content_p}")
                    endif()
                else()
                    set(_outfile "${_dest_dir}/${_hdr_name}")
                    if(EXISTS "${_outfile}")
                        file(READ "${_outfile}" _old)
                    else()
                        set(_old "")
                    endif()
                    if(NOT "${_old}" STREQUAL "${_content}")
                        file(WRITE "${_outfile}" "${_content}")
                    endif()
                endif()
            endif()
        endforeach()

        target_include_directories(${_target} PUBLIC
            "$<BUILD_INTERFACE:${QWINDOWKIT_GENERATED_INCLUDE_DIR}>"
        )
    endif()

    if(QWINDOWKIT_INSTALL)
        install(TARGETS ${_target}
            EXPORT ${QWINDOWKIT_INSTALL_NAME}Targets
            RUNTIME DESTINATION "${CMAKE_INSTALL_BINDIR}" OPTIONAL
            LIBRARY DESTINATION "${CMAKE_INSTALL_LIBDIR}" OPTIONAL
            ARCHIVE DESTINATION "${CMAKE_INSTALL_LIBDIR}" OPTIONAL
        )

        target_include_directories(${_target} PUBLIC
            "$<INSTALL_INTERFACE:${CMAKE_INSTALL_INCLUDEDIR}/${QWINDOWKIT_INSTALL_NAME}>"
        )

        if(NOT FUNC_NO_SYNC_INCLUDE)
             foreach(_hdr ${_headers})
                get_filename_component(_hdr_name ${_hdr} NAME)
                 set(_skip OFF)
                if(FUNC_SYNC_INCLUDE_OPTIONS)
                     list(LENGTH FUNC_SYNC_INCLUDE_OPTIONS _len)
                     math(EXPR _len "${_len} - 1")
                     foreach(_i RANGE 0 ${_len})
                        list(GET FUNC_SYNC_INCLUDE_OPTIONS ${_i} _opt)
                        if("${_opt}" STREQUAL "EXCLUDE")
                            math(EXPR _next_i "${_i} + 1")
                            if(_next_i LE ${_len})
                                list(GET FUNC_SYNC_INCLUDE_OPTIONS ${_next_i} _pattern)
                                file(RELATIVE_PATH _rel_from_src "${CMAKE_CURRENT_SOURCE_DIR}" "${_hdr}")
                                if("${_rel_from_src}" MATCHES "${_pattern}")
                                    set(_skip ON)
                                endif()
                            endif()
                        endif()
                     endforeach()
                endif()

                if(NOT _skip)
                    if("${_hdr_name}" MATCHES "_p\\.h$")
                        install(FILES ${_hdr}
                            DESTINATION "${CMAKE_INSTALL_INCLUDEDIR}/${QWINDOWKIT_INSTALL_NAME}/${_inc_name}/private"
                        )
                    else()
                        install(FILES ${_hdr}
                            DESTINATION "${CMAKE_INSTALL_INCLUDEDIR}/${QWINDOWKIT_INSTALL_NAME}/${_inc_name}"
                        )
                    endif()
                endif()
             endforeach()
        endif()
    endif()

endmacro()

# ----------------------------------
# Main Project
# ----------------------------------
add_subdirectory(core)

if(QWINDOWKIT_BUILD_WIDGETS)
    add_subdirectory(widgets)
endif()

if(QWINDOWKIT_BUILD_QUICK)
    add_subdirectory(quick)
endif()

# ----------------------------------
# Documentation
# ----------------------------------
# Documentation build removed.

# ----------------------------------
# Install
# ----------------------------------
if(QWINDOWKIT_INSTALL)
    include(CMakePackageConfigHelpers)
    write_basic_package_version_file(
        "${CMAKE_CURRENT_BINARY_DIR}/${QWINDOWKIT_INSTALL_NAME}ConfigVersion.cmake"
        VERSION ${QWINDOWKIT_VERSION}
        COMPATIBILITY AnyNewerVersion
    )

    configure_package_config_file(
        "${CMAKE_CURRENT_SOURCE_DIR}/../cmake/Config.cmake.in"
        "${CMAKE_CURRENT_BINARY_DIR}/${QWINDOWKIT_INSTALL_NAME}Config.cmake"
        INSTALL_DESTINATION "${CMAKE_INSTALL_LIBDIR}/cmake/${QWINDOWKIT_INSTALL_NAME}"
        NO_CHECK_REQUIRED_COMPONENTS_MACRO
    )

    install(FILES
        "${CMAKE_CURRENT_BINARY_DIR}/${QWINDOWKIT_INSTALL_NAME}Config.cmake"
        "${CMAKE_CURRENT_BINARY_DIR}/${QWINDOWKIT_INSTALL_NAME}ConfigVersion.cmake"
        DESTINATION "${CMAKE_INSTALL_LIBDIR}/cmake/${QWINDOWKIT_INSTALL_NAME}"
    )

    install(EXPORT ${QWINDOWKIT_INSTALL_NAME}Targets
        FILE ${QWINDOWKIT_INSTALL_NAME}Targets.cmake
        NAMESPACE ${QWINDOWKIT_INSTALL_NAME}::
        DESTINATION "${CMAKE_INSTALL_LIBDIR}/cmake/${QWINDOWKIT_INSTALL_NAME}"
    )

    # Install shared files
    include("../share/install.cmake")
endif()
